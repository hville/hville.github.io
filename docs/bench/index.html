<!doctype html>
<html lang=en>
<head>
	<title data-lang>benchmark // banc d'essais</title>
	<meta charset=utf-8>
	<meta name=viewport content="width=device-width, initial-scale=1.0">
	<meta name=description content="in browser benchmarking">
	<link rel="stylesheet" href="../_src/main.css">
	<script type=module src="../_src/data-lang.js"></script>
</head>

<body>

<div style="display: flex; justify-content: space-between;">
	<h2><a data-lang="this.href=`/#${this.lang}`"><i><svg><use href="/icon.svg#dice"></use></svg></i></a> schem.ist</h2>
	<h2 data-lang>benchmark // banc d'essais</h2>
	<data-lang>en fr</data-lang>
</div>
<hr>

<details>
	<summary data-lang>templates and examples // exemples de modèles</summary>
	<li data-lang data-hash="PPV=VfKJda-5CK)0pz#W#;j;DbEKVt=#RG5t6JO5B*(m-elEPO#zT5)e">
		<a lang=en> index conversions </a>
		<a lang=fr> conversion d'un index </a>
	</li>
	<li data-lang data-hash="o(GvJ(=*b2TQvwAc@Isi4qsu'F?4fwCpwZ6j~2rrQA,:)*TRjWnH&dWdl6HPchlRt@B0s)HaK05@@621R;1$aZvJe!aZS-odv;9!6m*+t9p$z2KxrxyISL')Wx=#/h@I+3ieX?vC&tBegCOwJfaR;D;hecktC7KwqJckI_/..1FFadfEa#QEn57Gm3YZNP(eY9y8Wp('~W72B,3m=c_B=vd$S5;9G!+hy1GJMh'mWBa'--$DTXwJ.oFkukQuwDb-#bxDQ'/8h8MB4dwGv,0)1o3Uv(;;&LG;c.@@g!zFovYQNyLrr;u4(JQ/Nkh33fpzmUg1A)B4F_FfnGXb$CGpRFW&ioUr8Jj$IgBs?o!6Oq$OJRM)mUf,wRj/yu'0;B-NqJZ56wE'?/5EBST'$eI3!0UAU:j_QC?VonYZ)">
		<a lang=en> selecting a single element in a tree of 30 </a>
		<a lang=fr> selection par attribut d'un élément parmis 30 éléments </a>
	</li>
	<li data-lang data-hash="2AHWy3kfDVqZmA),Oqp!5P-dyecTl0w,irA1T!JQ/T!4qBUzZ)+2nB=r8HMq&0W4UjLe&(~k@2q:~2tOu2QN3?p#CgJj3REIowAR.RxQc=Qon2~.btTd*mr/)&!@nTbmpV@/CBQ!I2_f6b@-E2Hp06#V9U;&T#XxgZT'RFFxd.MmoN55)yZliD3C!:C/*_wtT$$:LIIyl3zv:7exvKq0fuXpvo&ec2?9kY8xRoQ0852OHw5YlT+f)bX*eFdtCg_5*3D$NU=(B;2ALRP#?bb4Cb!chSz3k!8l0Oo8oQK)cZVZu)RnDtv&EpULL/c!,DxP&$b_UHu*.TU'';oKyplQhs#j.L~b0XCE,~&zJFiBLf#e/'aJ-YIh2z?FKRmp5*g!sRpWJ7ajEv7b~vLwX+;t5.Il2v@Cn5m.NVM2gJdf-'n-bX08SbA(Afg*1,JMG">
		<a lang=en>	selecting elements in a tree of 30 </a>
		<a lang=fr>	selection par attribut d'un groupe d'éléments parmis 30 éléments </a>
	</li>
	<li data-lang data-hash="~orh91bEv!x+xe)i_Yz4Bbual*rVGP)mB'H(Tf2/NH*EAD:3h);G((DrDzPA0Qa(nqRRZ-6$iK#Fw&UvQE9':LiX?.-1#b2_J7uj(xVm7!)RsA1.9,3g$Cu*9LcI$j75abT!S~b#A+DH@'eu_,t-z+Ey~zucfuZGWPu/Pt9w/9xN7Edz*in'TojdMmIO4eRQTu''T10dHo$0_SUOCV3#oS-aTTJU4)*gsh13S_6_WrS=/Cbu&x5vDxEPZ,QZOD?)PY$U3V_,db=M~Saoa4Nk+C0?lIH_1jzQ)q">
		<a lang=en> iterating through object keys and values </a>
		<a lang=fr> iteration sur l'ensemble des clés et valeurs d'un objet </a>
	</li>
	<script>
		document.querySelectorAll('details a').forEach( a=>a.href=`./#${ a.lang }/${ a.parentElement.dataset.hash }` )
	</script>
</details>

<table>
<!-- TODO table caption ? -->
<colgroup>
	<col style="width:75%;">
	<col>
</colgroup>
<thead>
	<tr>
		<th data-lang>imports and setup // imports et initialisation</th>
	</tr>
	<tr>
		<td>
			<pre><code id=init placeholder="// init code"></code></pre>
		</td>
		<td style="text-align: center; vertical-align: middle;">
			<button id=run data-lang>
				<span lang=en>run tests!<br>(takes a few seconds)</span>
				<span lang=fr>exécution!<br>(quelques secondes)</span>
			</button>
		</td>
	</tr>
	<tr>
		<th>code</th>
		<th style="text-align: center; vertical-align: middle; white-space: pre-wrap;">quartiles (Hz)</th>
	</tr>
</thead>

<tbody></tbody>

</table>
<template>
	<tr id=row>
		<td>
			<pre><code id=code placeholder="// test code"></code></pre>
		</td>
		<td style="text-align: center; vertical-align: middle;">
			<out id=time style="white-space: pre-wrap;"></out>
		</td>
	</tr>
</template>

<script type=module>

import {cast, frame, $, $$} from '/_npm/@hugov/inhtml.js'
import hashData from '../_src/hash-data.js'
import editable from '../_src/editable.js'

const init = $('#init'),
			tbody = $('tbody'),
			rows = tbody.children

// row factory
const makeRow = cast('template', ({row, code, time}, codeVal='') => {
	editable(code).textContent = codeVal
	time.update = res => time.textContent = !res ? '' : res.map( v => v.toPrecision(3) ).join('  ')
	code.onchange = () => {
		time.textContent = ''
		if (!code.textContent) row.remove()
		else if (!row.nextSibling) row.after(makeRow())
		save()
	}
	row.$ids = {code, time}
	return row
})


// simulation button handler
$('#run').onclick = () => {
	//TODO skip if no tests or just catch the error?
	const initCode = `import bench from '/_npm/@hugov/bench.js';${ init.textContent };`
	const execCode = `()=>bench([${
		Array.from(rows).slice(0,-1).map( row => row.$ids.code.textContent ).join(',\n')
	}])`
	const framedFcn = frame( execCode, {context: initCode} )
	framedFcn().then( res => {
		Array.from(rows).forEach( ({$ids}, i) => $ids.time.update( res[i] ) )
		framedFcn.remove()
	}).catch( err => console.log('error in test', err) )
}

// save / load
const saveData = hashData( ({data, lang}) => {
	if (rows.length) tbody.textContent = '' //reset rows
	if (data) {
		const itms = data.split('\v') //vertial tab as seperator
		init.textContent = itms.shift()
		itms.forEach( code => { if (code) tbody.append(makeRow(code)) } )
	}
	// one last empty line to allow adding new lines
	tbody.appendChild( makeRow() )
})

function save() {
	//TODO might be easier to to all rows and replace last with init
	const values = [init.textContent]
	//get all rows but the last
	for (let i=0; i<rows.length-1; ++i) values.push(rows[i].$ids.code.textContent)
	saveData( {data: values.join('\v')} )
}
editable(init)
init.onchange = save
</script>
</body>
