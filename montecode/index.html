<!doctype html>
<html lang=en>
<head>
	<title>monte carlo</title>
	<meta charset=utf-8>
	<meta name=viewport content="width=device-width, initial-scale=1.0">
	<meta name=description content="in browser benchmarking">
	<link rel="stylesheet" href="../_src/main.css">
	<script type=module src="../_src/data-lang.js"></script>
</head>

<body>

<div style="display: flex; justify-content: space-between;">
	<h2><a href="../">&#9884;</a> schem.ist - <span data-lang>monte carlo simulation // simulation monte carlo</span></h1>
	<data-lang>en fr</data-lang>
</div>
<hr>

<details>
	<summary data-lang>templates and examples // exemples de modèles</summary>
	<li data-lang>
		<a lang=en href="./#en/3c4*$zy)S1TDhu*AnHVFW2z_J1M5sL6-H+4/!8j/nQ~a7,KnALz?+)@yf&yk+&geD)KqkmbZ,&rvl)=5BnTN*JHMPb+pm(2RIKda1">
		variable rate and duration investment
		</a>
		<a lang=fr href="./#fr/3c4*$zy)S1TDhu*AnHVFW2z_J1M5sL6-H+4/!8j/nQ~a7,KnALz?+)@yf&yk+&geD)KqkmbZ,&rvl)=5BnTN*JHMPb+pm(2RIKda1">
		investissement à durée et rendement variable
	</a></li>
</details>
<!--
	TODO
	instruction
	single code block instead of lines
	no table
	graph
 -->

<table>
<!-- TODO table caption ? -->
<colgroup>
	<col style="width:75%;">
	<col>
</colgroup>
<thead>
	<tr>
		<th>code</th>
		<th style="text-align: center; vertical-align: middle;">
			<button id=run data-lang>results // résultats</button>
		</th>
	</tr>
</thead>
<tbody></tbody>
</table>

<template>
	<tr id=row>
		<td>
			<pre><code id=code contenteditable=true></code></pre>
		</td>
		<td style="text-align: center; vertical-align: middle;">
			<out id=span style="white-space: pre-wrap;"></out>
		</td>
	</tr>
</template>

<script type=module>

import {cast, $, $$} from '/_npm/@hugov.inhtml.js'
import hashData from '../_src/hash-data.js'
import SIM from '/_npm/@hugov.correl-range.js'
import editable from '../_src/editable.js'
import parse from './parse.js'

const tbody = $('tbody'),
			rows = tbody.children

// row factory
const makeRow = cast('template', ({row, code, span}, data='') => {
	editable(code)
	code.textContent = data
	span.update = res => span.textContent = !res ? '' : [.25, .75].map( p => res.Q(p).toPrecision(3) ).join(' ')

	code.onchange = () => {
		span.textContent = ''
		if (!code.textContent) row.remove()
		else if (!row.nextSibling) row.after(makeRow())
		saveData( getRows().join('\x00') )
	}

	row.$ids = {code, span}
	return row
})

// save / load
const saveData = hashData(dataString => {
	if (rows.length) tbody.textContent = '' //reset rows
	if (dataString) dataString.split('\x00').forEach( data => { if (data) tbody.append(makeRow(data)) } )
	// one last empty line to allow adding new lines
	tbody.appendChild( makeRow() )
})

function getRows() {
	const values = []
	//get all rows but the last
	for (let i=0; i<rows.length-1; ++i) values.push(rows[i].$ids.code.textContent)
	return values
}

// simulation button handler
const inRE = /[LNUW]\([^)]\)/g
$('#run').onclick = () => {
	try {
		const fcn = parse(getRows()),
					res = SIM(fcn).run(50_000).stats
		Object.keys(res).forEach( k => {
			const span = `( ${res[k].Q(.25).toPrecision(3)}   ${res[k].Q(.75).toPrecision(3)} )`
			console.log(k, fcn[k], span)
			rows[fcn[k]].$ids.span.textContent = span
		})
	} catch (e) {
		console.log('fail', e)
	}
}

</script>
</body>
